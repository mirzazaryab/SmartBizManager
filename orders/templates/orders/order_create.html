{% extends 'base.html' %}
{% load static %}

{% block title %}Create Order - SmartBizManager{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center min-vh-100 py-3">
  <div class="card shadow-lg border-0 position-relative" style="max-width: 500px; width: 100%; border-radius: 20px; overflow: hidden; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="d-none position-absolute w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0, 0, 0, 0.5); z-index: 10;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="card-body p-5">
      <div class="text-center mb-4">
        <img src="{% static 'images/logo.png' %}" alt="SmartBizManager Logo" style="width: 60px; height: 60px; margin-bottom: 1rem; transition: transform 0.3s ease;" class="logo-animate">
        <h2 class="fw-bold text-dark">Create New Order</h2>
        <p class="text-muted">Enter order details to add a new order</p>
      </div>
      <form method="POST" id="orderForm" novalidate>
        {% csrf_token %}
        <div class="mb-4 position-relative">
          <label for="id_customer" class="form-label fw-semibold">Customer</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-0" style="border-radius: 0.5rem 0 0 0.5rem;" data-bs-toggle="tooltip" title="Select the customer for this order">
              <i class="bi bi-person"></i>
            </span>
            {{ form.customer }}
          </div>
          <div id="customerError" class="invalid-feedback"></div>
        </div>
        <div class="mb-4 position-relative">
          <label for="id_product_name" class="form-label fw-semibold">Product Name</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-0" style="border-radius: 0.5rem 0 0 0.5rem;" data-bs-toggle="tooltip" title="Enter the product name">
              <i class="bi bi-box"></i>
            </span>
            {{ form.product_name }}
          </div>
          <div id="productNameError" class="invalid-feedback"></div>
        </div>
        <div class="mb-4 position-relative">
          <label for="id_quantity" class="form-label fw-semibold">Quantity</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-0" style="border-radius: 0.5rem 0 0 0.5rem;" data-bs-toggle="tooltip" title="Enter the quantity">
              <i class="bi bi-hash"></i>
            </span>
            {{ form.quantity }}
          </div>
          <div id="quantityError" class="invalid-feedback"></div>
        </div>
        <div class="mb-4 position-relative">
          <label for="id_unit_price" class="form-label fw-semibold">Unit Price</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-0" style="border-radius: 0.5rem 0 0 0.5rem;" data-bs-toggle="tooltip" title="Enter the unit price">
              <i class="bi bi-currency-dollar"></i>
            </span>
            {{ form.unit_price }}
          </div>
          <div id="unitPriceError" class="invalid-feedback"></div>
        </div>
        <div class="mb-4 position-relative">
          <label for="id_notes" class="form-label fw-semibold">Notes <span class="text-muted small">(Optional)</span></label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-0" style="border-radius: 0.5rem 0 0 0.5rem;" data-bs-toggle="tooltip" title="Additional order notes">
              <i class="bi bi-sticky"></i>
            </span>
            {{ form.notes }}
          </div>
          <div id="notesError" class="invalid-feedback"></div>
        </div>
        <div class="mb-4 position-relative">
          <label for="id_status" class="form-label fw-semibold">Status</label>
          <div class="input-group">
            <span class="input-group-text bg-dark text-white border-0" style="border-radius: 0.5rem 0 0 0.5rem;" data-bs-toggle="tooltip" title="Select order status">
              <i class="bi bi-flag"></i>
            </span>
            {{ form.status }}
          </div>
          <div id="statusError" class="invalid-feedback"></div>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary btn-lg flex-grow-1 position-relative overflow-hidden" style="transition: background-color 0.3s, transform 0.2s;">
            <span class="button-text"><i class="bi bi-save me-2"></i>Save</span>
            <span class="ripple"></span>
          </button>
          <a href="{% url 'orders:order_list' %}" class="btn btn-secondary btn-lg flex-grow-1" style="transition: background-color 0.3s, transform 0.2s;">
            <i class="bi bi-x-circle me-2"></i>Cancel
          </a>
        </div>
      </form>
      {% if form.errors %}
        <div class="mt-4">
          {% for field in form %}
            {% for error in field.errors %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-radius: 0.5rem;">
                {{ field.label }}: {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% for error in form.non_field_errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-radius: 0.5rem;">
              {{ error }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Inline CSS for custom styling -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

  body {
    font-family: 'Poppins', sans-serif;
    background: url('{% static "images/background.jpg" %}') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    position: relative;
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(245, 247, 250, 0.85) 0%, rgba(195, 207, 226, 0.85) 100%);
    z-index: -1;
  }

  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    animation: fadeIn 0.8s ease-in;
  }

  .card:hover {
    transform: translateY(-10px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
  }

  .form-control {
    border-radius: 0.5rem;
    transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s;
    background: rgba(255, 255, 255, 0.8);
  }

  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.3);
    background: rgba(255, 255, 255, 1);
  }

  .input-group-text {
    border-radius: 0.5rem 0 0 0.5rem;
    background: #343a40;
    transition: background-color 0.3s;
  }

  .input-group-text:hover {
    background: #0d6efd;
  }

  .btn-primary {
    background: linear-gradient(90deg, #0d6efd, #1a5bb8);
    border: none;
    border-radius: 0.5rem;
    position: relative;
    overflow: hidden;
  }

  .btn-primary:hover {
    background: linear-gradient(90deg, #005cbf, #0d6efd);
    transform: scale(1.05);
  }

  .btn-secondary {
    background: #6c757d;
    border: none;
    border-radius: 0.5rem;
  }

  .btn-secondary:hover {
    background: #5c636a;
    transform: scale(1.05);
  }

  .alert-danger {
    border-radius: 0.5rem;
    font-size: 0.9rem;
    background: rgba(220, 53, 69, 0.95);
    animation: slideIn 0.5s ease-in;
  }

  .invalid-feedback {
    font-size: 0.85rem;
  }

  .logo-animate:hover {
    transform: rotate(360deg);
  }

  /* Ripple effect for button */
  .btn-primary .ripple {
    position: absolute;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: scale(0);
    pointer-events: none;
  }

  .btn-primary.clicked .ripple {
    animation: ripple 0.6s ease-out;
  }

  @keyframes ripple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  @media (max-width: 576px) {
    .card {
      margin: 1.5rem;
    }
    .btn-lg {
      font-size: 0.9rem;
    }
  }
</style>

<!-- Inline JavaScript for client-side validation and interactions -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const form = document.getElementById('orderForm');
    const customer = document.getElementById('id_customer');
    const productName = document.getElementById('id_product_name');
    const quantity = document.getElementById('id_quantity');
    const unitPrice = document.getElementById('id_unit_price');
    const notes = document.getElementById('id_notes');
    const status = document.getElementById('id_status');
    const submitBtn = form.querySelector('button[type="submit"]');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Real-time validation
    function validateField(field, errorId, message, condition) {
      const errorEl = document.getElementById(errorId);
      if (condition) {
        field.classList.add('is-invalid');
        errorEl.textContent = message;
        return false;
      } else {
        field.classList.remove('is-invalid');
        errorEl.textContent = '';
        return true;
      }
    }

    productName.addEventListener('input', function() {
      validateField(this, 'productNameError', 'Product name must be at least 2 characters.', this.value.trim().length < 2);
    });

    quantity.addEventListener('input', function() {
      validateField(this, 'quantityError', 'Quantity must be at least 1.', this.value < 1);
    });

    unitPrice.addEventListener('input', function() {
      validateField(this, 'unitPriceError', 'Unit price must be at least 0.01.', this.value < 0.01);
    });

    form.addEventListener('submit', function(e) {
      // Reset feedback
      document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
      document.querySelectorAll('.form-control').forEach(el => el.classList.remove('is-invalid'));

      let valid = true;

      // Validate fields
      valid &= validateField(customer, 'customerError', 'Please select a customer.', !customer.value);
      valid &= validateField(productName, 'productNameError', 'Product name must be at least 2 characters.', productName.value.trim().length < 2);
      valid &= validateField(quantity, 'quantityError', 'Quantity must be at least 1.', quantity.value < 1);
      valid &= validateField(unitPrice, 'unitPriceError', 'Unit price must be at least 0.01.', unitPrice.value < 0.01);
      valid &= validateField(status, 'statusError', 'Please select a status.', !status.value);
      if (notes.value.trim()) {
        valid &= validateField(notes, 'notesError', 'Notes must be at least 5 characters.', notes.value.trim().length < 5);
      }

      if (!valid) {
        e.preventDefault();
      } else {
        // Show loading overlay
        loadingOverlay.classList.remove('d-none');
        submitBtn.disabled = true;
      }
    });

    // Ripple effect on button click
    submitBtn.addEventListener('click', function(e) {
      const rect = this.getBoundingClientRect();
      const ripple = this.querySelector('.ripple');
      ripple.style.left = `${e.clientX - rect.left}px`;
      ripple.style.top = `${e.clientY - rect.top}px`;
      this.classList.add('clicked');
      setTimeout(() => this.classList.remove('clicked'), 600);
    });
  });
</script>
{% endblock %}